# AGENTS.md — RedaStream+ Agent Memory
> Auto-generated by pre-flight on 2026-02-16. Keep this updated as you work.
> Read this file at the START of every new session.

## Pre-flight Report (written by agent, 2026-02-16)

### Codebase Status
- **Total files read**: 40+ app files, 24 components, 5 lib files
- **Existing routes found**:
  - `/` → Homepage with hero + content sections
  - `/movies` → Movies catalog with filters
  - `/tv` → TV series catalog with filters  
  - `/watch/movie/[id]` → Movie player page
  - `/watch/tv/[id]/[season]/[episode]` → TV episode player page
  - `/search` → Search page
  - `/movie/[id]`, `/tv/[id]` → Detail pages (referenced but not read)
  - **Multiple test routes** (test-search, test-simple, etc.) - cleanup candidates

- **Current player**: `PlayerEmbed.tsx` component that embeds third-party streaming iframes
  - Uses multiple providers: Vidnest (priority 0), Videasy (priority 1), VidSrc (priority 2)
  - Movie URL pattern: `https://vidnest.fun/movie/{id}`
  - TV URL pattern: `https://vidnest.fun/tv/{id}/{season}/{episode}`
  - Server switching with tabs, iframe-based player

- **TMDB functions already exist** (in `lib/tmdb.ts`):
  - `tmdbFetch()` → Generic TMDB fetch with auth + caching
  - `buildTmdbUrl()` → URL builder with API key or Bearer token
  - `hasTmdbCredentials()` → Check if credentials exist
  - `errorResponse()` → Standard error response helper

- **Auth system**: No auth system exists yet (references to profile page in Header are placeholders)

### Ready to Implement
✅ All memory files created
✅ next.config.js read (already has CSP + iframe origins configured)
✅ hls.js NOT yet installed (will install in Step 5)
✅ Risks identified (see below)

### Risks & Notes
- **Risk 1**: Current player (PlayerEmbed.tsx) uses third-party iframes, needs to be replaced with RivePlayer
  - Current iframe src: `https://vidnest.fun/movie/{id}` (and other providers)
  - New RivePlayer will need: `https://watch.rivestream.app` in CSP frame-src
  
- **Risk 2**: Multiple test/debug search pages exist that should be cleaned up:
  - test-basic, test-complete, test-debug, test-form, test-new-search, test-search, test-search-simple, test-search-ui, test-simple, test-simple-search, test-working-search
  - debug-search, manual-search, search-debug, search-simple, simple-search
  
- **Risk 3**: No K-Drama, Anime, Manga, or Live TV routes exist yet - all net new

- **Risk 4**: TMDB has limited K-Drama/Anime metadata (uses with_original_language filter)
  - K-Dramas: `with_original_language=ko` on /discover/tv
  - Anime: `with_original_language=ja` on /discover/tv with anime genre
  
- **Risk 5**: No lib/kitsu.ts or lib/iptv.ts files exist - need to create from scratch

- **Risk 6**: Header.tsx currently has 3 nav items (Home, Movies, TV Series) - will need to add:
  - K-Dramas, Anime, Manga, Live TV links

### My Implementation Plan
I will implement tasks in this order based on priority:
1. **Install hls.js** (dependency for IPTV player)
2. **Update .env.local** (if needed)
3. **Create RivePlayer.tsx** (replacement for PlayerEmbed with Rivestream embed)
4. **Update watch pages** to use RivePlayer instead of PlayerEmbed
5. **Add TMDB helpers** for K-Dramas and Anime (discover filters)
6. **Create /kdramas page** (similar to /tv but with ko language filter)
7. **Create /anime page** (similar to /tv but with ja language + anime genre)
8. **Create lib/kitsu.ts** (Kitsu.io API client)
9. **Create /manga page** (using Kitsu.io)
10. **Create lib/iptv.ts** (IPTV-org parser)
11. **Create IPTVPlayer.tsx** (HLS.js player component)
12. **Create /live page** (IPTV channel browser)
13. **Update Header** with new nav links
14. **Update homepage** with new content sections
15. **Verify next.config.js** has all image domains
16. **Test everything** before deploy

---

## Project
- **Name**: RedaStream+
- **URL**: https://reda-stream.vercel.app
- **Framework**: Next.js 14.2.5 with App Router
- **Styling**: Tailwind CSS 3.4.10
- **Language**: TypeScript 5.6.2
- **Deployment**: Vercel

## Existing Routes
- `/` → Homepage with hero + 6 content sections (trending, popular movies, popular TV, top rated movies, top rated TV, upcoming)
- `/movies` → Movies catalog with filters (genre, year, language, sort)
- `/tv` → TV series catalog with filters
- `/watch/movie/[id]` → Movie player page with PlayerEmbed
- `/watch/tv/[id]/[season]/[episode]` → TV episode player with WatchTvEpisodeClient
- `/search` → Search page
- Multiple test routes (candidates for cleanup)

## Existing Components
- `Header.tsx` → Sticky nav with logo, search bar, user profile (client component)
- `EnhancedHeroSection.tsx` → Hero carousel with trending content
- `ContentSection.tsx` → Horizontal scrollable content row (trending, popular, etc.)
- `MediaCard.tsx` → Individual poster card with rating, title, media type
- `MediaGrid.tsx` → Grid layout for catalog pages
- `CatalogResults.tsx` → Catalog results with infinite scroll + pagination
- `FiltersBar.tsx` → Genre, year, language filters for catalog pages
- `PlayerEmbed.tsx` → Current iframe-based player (will be replaced)
- `EnhancedFooter.tsx` → Footer component
- `LoadingSkeleton.tsx` → Loading state skeletons
- `ErrorBoundary.tsx` → Error boundary wrapper
- Multiple search components (WorkingSearch, SimpleSearch, NewSearch, etc.)

## TMDB Functions Already Implemented (lib/tmdb.ts)
- `tmdbFetch<T>(path, query)` → Generic TMDB API fetch with auth + caching
- `buildTmdbUrl(path, query)` → Build TMDB URL with API key or Bearer token
- `hasTmdbCredentials()` → Check if TMDB_API_KEY or TMDB_READ_TOKEN exist
- `errorResponse(message, status)` → Create error response

## Streaming Helpers (lib/streaming.ts)
- `getMovieServers(id)` → Returns array of movie streaming servers
- `getTvServers(id, season, episode)` → Returns array of TV streaming servers
- Providers: Vidnest (priority 0), Videasy (priority 1), VidSrc (priority 2)

## Environment Variables
- `TMDB_API_KEY` ✅ or `TMDB_READ_TOKEN` ✅ (v4 bearer preferred)
- `CACHE_TTL_SECONDS` ✅ (default 300)
- `ALLOWED_IFRAME_ORIGINS` ✅ (CSV of allowed iframe hosts)
- **MISSING**: Any Kitsu.io API key (check if needed)
- **MISSING**: Any Rivestream API key (check if needed)

## Auth System
- **No auth system currently implemented**
- Header.tsx shows placeholder profile UI (viewer@redastream.app)
- `/profile` route not yet created

## Player Implementation
- **Current**: `PlayerEmbed.tsx` component
  - Uses iframe embeds from third-party providers
  - Movie pattern: `https://vidnest.fun/movie/{id}`
  - TV pattern: `https://vidnest.fun/tv/{id}/{season}/{episode}`
  - Server tabs for fallback switching
  - Located in: `components/PlayerEmbed.tsx`
  
- **Needs to be replaced with**: `RivePlayer.tsx` component
  - Should use Rivestream embed URLs
  - Pattern: `https://watch.rivestream.app/movie/{id}` or similar

## Known Issues / Risks
- next.config.js may need to add rivestream domains for images/frames
- Multiple test/debug routes should be cleaned up
- No loading state on some watch pages
- Search components are duplicated (WorkingSearch, SimpleSearch, NewSearch, etc.)

## Naming Conventions Used in This Codebase
- **Components**: PascalCase (e.g., `EnhancedHeroSection.tsx`)
- **Utilities**: camelCase (e.g., `tmdbFetch`)
- **Pages**: `page.tsx` in route folders (Server Components by default)
- **Client components**: Must have `"use client"` directive at top
- **Data fetching**: `fetch()` with `next: { revalidate: 300 }` for caching
- **CSS**: Tailwind utility classes only, no CSS modules
- **Imports**: Use `@/components/*` and `@/lib/*` path aliases

## Folder Structure
```
RedaStream/
├── app/
│   ├── api/                      # API routes
│   │   ├── details/[type]/[id]/  # Movie/TV details
│   │   ├── discover/             # TMDB discover
│   │   ├── filters/              # Genre/year filters
│   │   ├── search/               # Search proxy
│   │   ├── stream/               # Streaming servers
│   │   ├── trending/             # Trending content
│   │   └── tv/                   # TV-specific endpoints
│   ├── movies/                   # Movies catalog page
│   ├── tv/                       # TV catalog page
│   ├── watch/
│   │   ├── movie/[id]/           # Movie player
│   │   └── tv/[id]/[season]/[episode]/  # TV player
│   ├── [test routes]/            # Multiple test routes (cleanup)
│   ├── layout.tsx                # Root layout
│   ├── page.tsx                  # Homepage
│   └── globals.css               # Global styles
├── components/
│   ├── Header.tsx
│   ├── EnhancedHeroSection.tsx
│   ├── ContentSection.tsx
│   ├── MediaCard.tsx
│   ├── PlayerEmbed.tsx           # Current player (to be replaced)
│   ├── FiltersBar.tsx
│   ├── CatalogResults.tsx
│   └── home/                     # Homepage-specific components
│       ├── fallbackData.ts       # Fallback data when TMDB unavailable
│       └── [other home components]
├── lib/
│   ├── tmdb.ts                   # TMDB API client
│   ├── streaming.ts              # Streaming server helpers
│   ├── catalog.ts                # Catalog/filter helpers
│   ├── search.ts                 # Search helpers
│   └── baseUrl.ts                # URL utilities
├── public/
│   ├── logo-wordmark.svg
│   ├── favicon.svg
│   └── [other static assets]
├── MEMORY.md                     # Original project memory
├── PLAN.md                       # Original implementation plan
├── README.md                     # Project README
├── next.config.js                # Next.js config
├── tailwind.config.ts            # Tailwind config
├── tsconfig.json                 # TypeScript config
└── package.json                  # Dependencies
```

## Dependencies Already Installed
- `next`: 14.2.5
- `react`: 18.2.0
- `react-dom`: 18.2.0
- `typescript`: 5.6.2
- `tailwindcss`: 3.4.10
- `lucide-react`: 0.544.0 (icon library)
- `fuse.js`: 7.0.0 (fuzzy search)
- `@vercel/analytics`: ^1.5.0
- **NOT INSTALLED YET**: `hls.js` (needed for IPTV player)

## Things to NOT Touch
- **Do not modify** existing TMDB functions in `lib/tmdb.ts` (only ADD new functions)
- **Do not delete** existing API routes (they're being used)
- **Do not break** the color scheme (slate/cyan/indigo gradients)
- **Do not modify** the existing streaming.ts providers (Vidnest, Videasy, VidSrc)
- **Preserve** the existing homepage sections (can add to them, but don't remove)

## Color Scheme
- **Background**: `bg-slate-950`, `bg-slate-900`, `bg-black`
- **Borders**: `border-slate-800/60`, `border-slate-700`
- **Text**: `text-white`, `text-slate-300`, `text-slate-400`
- **Accent**: `bg-cyan-500`, `text-cyan-300`, `border-cyan-400`
- **Secondary**: `bg-indigo-500` (used for TV sections)
- **Gradients**: `from-black via-slate-950 to-black`

## Image Domains (next.config.js)
Current allowed domains:
- `image.tmdb.org` ✅
- `via.placeholder.com` ✅  
- `www.themoviedb.org` ✅

**Will need to add:**
- Kitsu.io image domains (e.g., `media.kitsu.app`)
- Rivestream domains (if using image assets)

## CSP Frame Sources (next.config.js)
Current allowed iframe origins:
- `vidsrc.to` and `*.vidsrc.to`
- `vidsrc.vip` and `*.vidsrc.vip`
- `vidsrc.xyz` and `*.vidsrc.xyz`
- `vidlink.pro` and `*.vidlink.pro`
- `vidnest.fun` and `*.vidnest.fun`
- `multiembed.mov` and `*.multiembed.mov`
- `autoembed.to` and `*.autoembed.to`
- `cloudnestra.com` and `*.cloudnestra.com`
- `player.videasy.net`

**Will need to add:**
- `watch.rivestream.app` and `*.rivestream.app` (for RivePlayer)
